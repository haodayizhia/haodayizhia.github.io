[{"content":" Step 1 准备工作 Step 2 配置部分 Step 3 启动服务 Appendix 附加说明 一、certbot 证书续签 手动续签 自动续签 二、其他问题 三、参考链接 Step 1 准备工作 自行购买境外VPS，推荐 AWS EC2，首次注册绑定 VISA 信用卡可免费使用一年。 什么是 AWS Free Tier？ AWS Free Tier 使客户能够在各服务的指定限制内免费探索和试用 AWS 服务。免费套餐包含三种不同类型的产品、12 个月免费试用、永久免费和短期免费试用。12 个月免费服务允许客户自账户激活之日起一年内在指定限制内免费使用该产品。永久免费服务允许 AWS 客户在指定限制内免费使用该产品。根据所选服务，短期试用服务可以在指定的时间段内免费使用，或者免费使用一次。有关免费提供的服务和相应的限制，在 Free Tier 页面的每张卡片中有详细说明。如果您的应用程序使用量超过了 Free Tier 限制，您只需支付标准的按需付费服务费率（请参阅服务页面获取完整的定价信息）。存在限制条件；有关更多详细信息，请参阅优惠条款。\n准备一个域名（推荐腾讯云、阿里云等），示例使用 example.com。\n将域名托管到 cloudflare，然后解析到服务器 IP。\nStep 2 配置部分 在服务器终端上逐条运行以下命令，请自行sudo：\n# 更新软件包列表 apt update # 安装Xray-core bash -c \u0026#34;$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)\u0026#34; @ install # 覆盖Xray-core配置 vim /usr/local/etc/xray/config.json # 安装certbot和nginx apt install certbot apt install nginx # certbot申请证书 certbot certonly # 覆盖nginx配置 vim /etc/nginx/conf.d/v2ray.conf # 替换配置中的域名 # echo -n \u0026#34;新域名：\u0026#34; # read newDomain # sed -i \u0026#34;s/example.com/$newDomain/g\u0026#34; /etc/nginx/conf.d/v2ray.conf 其中，config.json文件内容如下：\n{ \u0026#34;inbounds\u0026#34;: [{ \u0026#34;port\u0026#34;: 10086, //端口范围0至65535，请确保和nginx的端口号一致 \u0026#34;listen\u0026#34;:\u0026#34;127.0.0.1\u0026#34;, \u0026#34;protocol\u0026#34;: \u0026#34;vmess\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;clients\u0026#34;: [ { \u0026#34;id\u0026#34;: \u0026#34;41747268-f36b-416f-b68b-2f8e69fa472b\u0026#34;, //此处为安装时生成的id \u0026#34;level\u0026#34;: 1, \u0026#34;alterId\u0026#34;: 0 //此处为安装时生成的alterId } ] }, \u0026#34;streamSettings\u0026#34;: { \u0026#34;network\u0026#34;: \u0026#34;ws\u0026#34;, \u0026#34;wsSettings\u0026#34;: { \u0026#34;path\u0026#34;: \u0026#34;/ray\u0026#34; //此处为路径，需要和下面NGINX上面的路径配置一样 } } }], \u0026#34;outbounds\u0026#34;: [{ \u0026#34;protocol\u0026#34;: \u0026#34;freedom\u0026#34;, \u0026#34;settings\u0026#34;: {} },{ \u0026#34;protocol\u0026#34;: \u0026#34;blackhole\u0026#34;, \u0026#34;settings\u0026#34;: {}, \u0026#34;tag\u0026#34;: \u0026#34;blocked\u0026#34; }], \u0026#34;routing\u0026#34;: { \u0026#34;rules\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;field\u0026#34;, \u0026#34;ip\u0026#34;: [\u0026#34;geoip:private\u0026#34;], \u0026#34;outboundTag\u0026#34;: \u0026#34;blocked\u0026#34; } ] } } v2ray.conf文件内容\nserver { listen 443 ssl; server_name example.com; # 修改为自己的域名 ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem; # 将example.com修改为自己的域名 ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem; # 将example.com修改为自己的域名 location /ray { # 修改为你自己的路径，需要和V2RAY里面的路径一样 proxy_redirect off; proxy_pass http://127.0.0.1:10086; # 修改为你自己的v2ray服务器端口，就是这里需要和上面V2RAY配置文件里面的端口号相同。 proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_connect_timeout 60s; proxy_read_timeout 86400s; proxy_send_timeout 60s; } } Step 3 启动服务 # 启动/停止/查看v2ray服务 systemctl start/stop/status v2ray # 检测nginx配置是否正确 nginx -t # 启动/停止/查询nginx服务 systemctl start/stop/status nginx Appendix 附加说明 一、certbot 证书续签 certbot证书可以手动续签和自动续签，自动续签方式有两种：系统服务 systemd 或创建 crontab 周期任务。\n手动续签 sudo certbot certificates\t# 证书有效期查询 sudo systemctl stop nginx\t# 关闭nginx，解除占用端口 sudo certbot renew\t# 续签证书 sudo systemctl restart nginx\t# 重启nginx 自动续签 systemd服务单元文件 前面提到certbot默认不会在运行了systemd的系统上通过crontab自动续签，通过systemctl管理。\n# 启动/查看服务 sudo systemctl start/status certbot.service # 查看certbot服务 sudo systemctl start/status certbot.timer # 查看certbot的定时器 这两个服务的配置文件路径通常在：/lib/systemd/system/certbot.service和/lib/systemd/system/certbot.timer。\n如果启用了服务却没有自动续签，查看系统日志：\nsudo journalctl -u certbot 报错显示我是因为开启nginx占用了端口导致的，有三种修改方法：\n使用/etc/sysconfig/certbot设置 Hook（推荐） 如果/etc/sysconfig/certbot文件已在certbot-renew.service中定义为EnvironmentFile，可以直接在该文件中添加 PRE_HOOK和POST_HOOK变量。\nvim /etc/sysconfig/certbot # 添加以下内容 PRE_HOOK=\u0026#34;--pre-hook \u0026#39;systemctl stop nginx\u0026#39;\u0026#34; POST_HOOK=\u0026#34;--post-hook \u0026#39;systemctl start nginx\u0026#39;\u0026#34; certbot-renew.service中手动添加 [Unit] Description=Certbot Documentation=file:///usr/share/doc/python-certbot-doc/html/index.html Documentation=https://certbot.eff.org/docs [Service] Type=oneshot ExecStart=certbot renew --pre-hook \u0026#34;systemctl stop nginx\u0026#34; --post-hook \u0026#34;systemctl restart nginx\u0026#34; PrivateTmp=true 使用certbot renew自带的Hook目录（自行搜索） 然后重新加载systemd并生效：\nsystemctl daemon-reload systemctl start certbot.service 或者使用python3-certbot-nginx插件，见 https://www.f5.com/company/blog/nginx/using-free-ssltls-certificates-from-lets-encrypt-with-nginx。\ncrontab建立周期任务 certbot 默认配置：\n# /etc/cron.d/certbot: crontab entries for the certbot package # # Upstream recommends attempting renewal twice a day # # Eventually, this will be an opportunity to validate certificates # haven\u0026#39;t been revoked, etc. Renewal will only occur if expiration # is within 30 days. # # Important Note! This cronjob will NOT be executed if you are # running systemd as your init system. If you are running systemd, # the cronjob.timer function takes precedence over this cronjob. For # more details, see the systemd.timer manpage, or use systemctl show # certbot.timer. SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin 0 */12 * * * root test -x /usr/bin/certbot -a \\! -d /run/systemd/system \u0026amp;\u0026amp; perl -e \u0026#39;sleep int(rand(43200))\u0026#39; \u0026amp;\u0026amp; certbot -q renew 如果系统运行了systemd，这里crontab不会执行！\n手动添加crontab任务：\ncrontab -e 0 0 1 */3 * sudo systemctl stop nginx \u0026amp;\u0026amp; certbot -q renew --renew-hook \u0026#34;systemctl restart nginx\u0026#34; //每隔3个月的当月第一天0分0秒执行一次 前5位表示分(0-60)、时(0-24)、天(1-30)、月(1-12)、周(0-6)。 - q表示不输出执行结果日志。\n补充：\ncrontab -l //查看当前用户周期任务 crontab -l -u root //查看root用户周期任务 cat /etc/passwd | cut -f 1 -d : | xargs -I {} crontab -l -u {} //以root用户执行，查看所有周期任务 /var/spool/cron/crontabs/ 路径下有所有用户的任务。 /etc/crontab 负责调度各种管理和维护任务。 /etc/cron.d/ 存放着要执行的crontab任务。 二、其他问题 为什么部署完成还是用不了？\ncloudflare 的 SSL/TLS 等级要改为 Full。 \u0026hellip; 三、参考链接 Xray 官方文档 Certbot 官方教程 Let\u0026rsquo;s Encrypt 与 Nginx ","permalink":"http://localhost:1313/posts/my-first-post/","summary":"\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#step-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\"\u003eStep 1 准备工作\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#step-2-%E9%85%8D%E7%BD%AE%E9%83%A8%E5%88%86\"\u003eStep 2 配置部分\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#step-3-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1\"\u003eStep 3 启动服务\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#appendix-%E9%99%84%E5%8A%A0%E8%AF%B4%E6%98%8E\"\u003eAppendix 附加说明\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E4%B8%80certbot-%E8%AF%81%E4%B9%A6%E7%BB%AD%E7%AD%BE\"\u003e一、certbot 证书续签\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%8B%E5%8A%A8%E7%BB%AD%E7%AD%BE\"\u003e手动续签\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%87%AA%E5%8A%A8%E7%BB%AD%E7%AD%BE\"\u003e自动续签\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E4%BA%8C%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98\"\u003e二、其他问题\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E4%B8%89%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"\u003e三、参考链接\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"step-1-准备工作\"\u003eStep 1 准备工作\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e自行购买境外VPS，推荐 \u003cstrong\u003eAWS EC2\u003c/strong\u003e，首次注册绑定 VISA 信用卡可免费使用一年。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003e什么是 AWS Free Tier？\u003c/strong\u003e\nAWS Free Tier 使客户能够在各服务的指定限制内免费探索和试用 AWS 服务。免费套餐包含三种不同类型的产品、12 个月免费试用、永久免费和短期免费试用。12 个月免费服务允许客户自账户激活之日起一年内在指定限制内免费使用该产品。永久免费服务允许 AWS 客户在指定限制内免费使用该产品。根据所选服务，短期试用服务可以在指定的时间段内免费使用，或者免费使用一次。有关免费提供的服务和相应的限制，在 Free Tier 页面的每张卡片中有详细说明。如果您的应用程序使用量超过了 Free Tier 限制，您只需支付标准的按需付费服务费率（请参阅服务页面获取完整的定价信息）。存在限制条件；有关更多详细信息，请参阅优惠条款。\u003c/p\u003e\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e准备一个域名（推荐腾讯云、阿里云等），示例使用 \u003ccode\u003eexample.com\u003c/code\u003e。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e将域名托管到 \u003ca href=\"https://dash.cloudflare.com/\"\u003ecloudflare\u003c/a\u003e，然后解析到服务器 IP。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"step-2-配置部分\"\u003eStep 2 配置部分\u003c/h2\u003e\n\u003cp\u003e在服务器终端上逐条运行以下命令，请自行\u003ccode\u003esudo\u003c/code\u003e：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 更新软件包列表\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 安装Xray-core\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebash -c \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecurl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e @ install\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 覆盖Xray-core配置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evim /usr/local/etc/xray/config.json\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 安装certbot和nginx\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install certbot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# certbot申请证书\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecertbot certonly\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 覆盖nginx配置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evim /etc/nginx/conf.d/v2ray.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 替换配置中的域名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# echo -n \u0026#34;新域名：\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# read newDomain\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# sed -i \u0026#34;s/example.com/$newDomain/g\u0026#34; /etc/nginx/conf.d/v2ray.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e其中，\u003ccode\u003econfig.json\u003c/code\u003e文件内容如下：\u003c/p\u003e","title":"自动部署TLS/Xray教程简洁版"}]